<img width="496" height="303" alt="image" src="https://github.com/user-attachments/assets/41451740-844d-447f-a136-4d5c36d0e391" /><img width="253" height="32" alt="image" src="https://github.com/user-attachments/assets/ce4b1d68-f89e-484c-8390-3bb5ba9e9bfd" /># Справочник по FreeRTOS

## Содержание

## Полезные ссылки

[Сайт FreeRTOS](https://www.freertos.org/)

[Мануал CMSIS FreeRTOS](https://www.st.com/resource/en/user_manual/um1722-developing-applications-on-stm32cube-with-rtos-stmicroelectronics.pdf)

## Введение

FreeRTOS - это открытая (open-source) операционная система реального времени (RTOS) для микроконтроллеров и встраиваемых систем. Она обеспечивает многозадачность, управление потоками, планирование задач и синхронизацию в ограниченных по ресурсам устройствах.

FreeRTOS абсолютно бесплатна (лицензия MIT) даже для коммерческих приложений. Использование FreeRTOS не накладывает обязательство по открытию исходного кода, не накладывается обязательство по изменению ядра ОС.

Преимущества FreeRTOS:

- Легкая и быстрая - FreeRTOS занимает 0,5 КБ оперативной памяти и от 5 до 10 КБ ПЗУ
- Простая ахитектура
- Портируемость
- Открытый исходный код

## Структура FreeRTOS

FreeRTOS настраивается при помощи единственного файла - FreeRTOSConfig.h - он содержит все константы и макросы для конфигурации проекта

## FreeRTOS + stm32 + CubeIDE

Для работы с FreeRTOS на STM32 удобно использовать CubeIDE. Для того чтобы добавить FreeRTOS в проект необходимо включить его на вкладке Middleware -> FreeRTOS после чего выбрать версию CMSIS_V1 или CMSIS_V2.

<img width="626" height="158" alt="image" src="https://github.com/user-attachments/assets/7c4c48d6-cf2d-4574-8176-e36c990baf65" />

CMSIS_RTOS - это обертка для чистого FreeRTOS - она разработана для легкого перехода с одного типа RTOS на другой для ARM-процессоров (Например с FreeRTOS на RTX)

Для работы с STM32 лучше использовать CMSIS_V2 - это более современная версия чем V1. В отличии от V1 управление временем происходит в тиках, а не мс, доступны расширенные типы объектов, идентификаторы обьектов - структуры, а не указатели как в V1. V2 предоставляет более чистый и унифицированный API.

В первую очередь необходимо настроить RTOS. Сделать это можно во вкладке config parameters. По сути этот раздел изменяет файл FreeRTOSConfig.h. Описание каждого параметра приведено в ниже
### MPU/FPU

#### ENABLE_MPU

`ENABLE_MPU` - защита памяти, используется когда необходима безопасность или изоляция задач. Недоступно в CMSIS_V2.

#### ENABLE_FPU

`ENABLE_FPU` - позволяет безопасно использовать float числа. Если выключено - экономит время, но небезопасно работать с float числами.

### Config parameters

#### USE_PREEMTION

`USE_PREEMTION` - Параметр который определяет тип многозадачности.

При значении `1 (enabled)` - включает режим вытесняющей многозадачности, приостанавливает выполнение низкоприоритетной задачи (сохраняет ее сотояние и стек) при появлении готовой к выполнению высокоприоритетной и переключается на нее. При значении `0 (disabled)` включает кооперативный режим. 

При использовании кооперативного режима задачи сами должны вызывать `vTaskYIELD` в вытесняющем режиме задачи переключаются между друг другом при помощи планировщика, в кооперативном режиме нужно управлять временм вручную, кооперативный режим может привести к блокировке CPU одной задачей, в вытесняющем режиме нужно работать над синхронизацией задач.

#### USE_TIME_SLICING

`USE_TIME_SLICING` - параметр который включает равномерное выполнение задач одного приорита. Если значение параметра `1 (enabled)` то разделение времени включено. Если `0 (disabled)` то выключен.

При включенном параметре если есть несколько задач с одинаковым приоритетом готовых к выполнению, то эти задачи будут выполняться по очереди равномерно (тоесть если есть задача А и задача Б с одинаковым приоритетом то при тике 1 - выполняется задача А, на втором тике выполнение задачи А приостанавливается и начинается выполнение задачи Б, на третьем тике выполнение задачи Б приостанавливается  и продолжается выполнение задачи А и тд).

__В CMSIS_V2 нет отдельной настройки TIME_SLICING он включается автоматически при включении PREEMTION.__

#### CPU_CLOCK_HZ

`CPU_CLOCK_HZ` - частота системного тактирования ядра с которым работает FreeRTOS. По умолчанию равна частоте ядра STM. Чем выше частота тем быстрее реагирует система, но больше нагрузка на CPU и выше энергопотребление. Для обычных систем рекомендуется 1000 Гц, для энергоемких 250 - 400 Гц.

#### TICK_RATE_HZ

`TICK_RATE_HZ` - частота системного тика. От него зависят функции `osDelay()` и `vTaskDelay` (считают время в тиках). Скорость переключения задач по тайм-шерингу и точность таймеров RTOS. В реальности от 10 до 10000 Гц можно использовать.

#### MAX_PRIORITIES

`MAX_PRIORITIES` - максимальное количество приоритетов. В CMSIS_V2 по умолчанию 56. Это значит доступны приоритеты от 0 до 55, где 0 - минимальный приоритет (обрабатываются самыми последними), 55 - максимальный приоритет. Доп нагрузки не создает, только немного съедает памяти (на таблицу приоритетов)

#### MINIMAL_STACK_SIZE

`MINIMAL_STACK_SIZE` - минимальный размер стека в словах (1 слово - 4 байт).

Это значение используется для задач в которых не задан размер стека явно, а также для Idle Task и Timer Service Task если они подключены. 

В стеке задачи хранятся:

- локальные переменные
- адрес возврата при вызове функций
- Регистры CPU при переключении контекста (для CortexM около 16-20 слов)
- буфер для вызова функций `printf`, `sprintf` и др
- Значения используемые при вызовах HAL и CMSIS функций

По сути своей это рабочая память задачи.

Можно исмерить используемый стек. `UBaseType_t freeStack = uxTaskGetStackHighWaterMark(NULL);` функция вернет минимальное свободное место.

Также можно вызвать `vTaskList(char *buffer);` чтобы вывести список задач и свободный стек каждой (если включен `configUSE_TRACE_FACILITY`)



| Параметр | Принимаемые значение | описание |
| ------------- | ------------- | ------------- |
| `USE_PREEMTION`  | Вытесняющая многозадачность или корпоративная многозадачность | `1 (enabled)` - вытесняющая многозадачность `0 (disabled)` - кооперативная многозадачность|
| `USE_TIME_SLICING`  | Разделение задач одинакового приоритета по времени | `1 (enabled)` - включено `0 (disabled)` - выключено |
| `CPU_CLOCK_HZ`  | Частота системного тика  | Число в герцах |
| `MAX_PRIORITIES`  | Число приоритетов  | по умолчанию 56 (от 0 до 55) |
| `MINIMAL_STACK_SIZE`  | минимальный размер стека в словах (4 байта слово)  | от 64 до 3840 |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
