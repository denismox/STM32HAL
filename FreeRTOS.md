<img width="496" height="303" alt="image" src="https://github.com/user-attachments/assets/41451740-844d-447f-a136-4d5c36d0e391" /><img width="253" height="32" alt="image" src="https://github.com/user-attachments/assets/ce4b1d68-f89e-484c-8390-3bb5ba9e9bfd" /># Справочник по FreeRTOS

## Содержание

## Полезные ссылки

[Сайт FreeRTOS](https://www.freertos.org/)

[Мануал CMSIS FreeRTOS](https://www.st.com/resource/en/user_manual/um1722-developing-applications-on-stm32cube-with-rtos-stmicroelectronics.pdf)

## Введение

FreeRTOS - это открытая (open-source) операционная система реального времени (RTOS) для микроконтроллеров и встраиваемых систем. Она обеспечивает многозадачность, управление потоками, планирование задач и синхронизацию в ограниченных по ресурсам устройствах.

FreeRTOS абсолютно бесплатна (лицензия MIT) даже для коммерческих приложений. Использование FreeRTOS не накладывает обязательство по открытию исходного кода, не накладывается обязательство по изменению ядра ОС.

Преимущества FreeRTOS:

- Легкая и быстрая - FreeRTOS занимает 0,5 КБ оперативной памяти и от 5 до 10 КБ ПЗУ
- Простая ахитектура
- Портируемость
- Открытый исходный код

## Структура FreeRTOS

FreeRTOS настраивается при помощи единственного файла - FreeRTOSConfig.h - он содержит все константы и макросы для конфигурации проекта

## FreeRTOS + stm32 + CubeIDE

Для работы с FreeRTOS на STM32 удобно использовать CubeIDE. Для того чтобы добавить FreeRTOS в проект необходимо включить его на вкладке Middleware -> FreeRTOS после чего выбрать версию CMSIS_V1 или CMSIS_V2.

<img width="626" height="158" alt="image" src="https://github.com/user-attachments/assets/7c4c48d6-cf2d-4574-8176-e36c990baf65" />

CMSIS_RTOS - это обертка для чистого FreeRTOS - она разработана для легкого перехода с одного типа RTOS на другой для ARM-процессоров (Например с FreeRTOS на RTX)

Для работы с STM32 лучше использовать CMSIS_V2 - это более современная версия чем V1. В отличии от V1 управление временем происходит в тиках, а не мс, доступны расширенные типы объектов, идентификаторы обьектов - структуры, а не указатели как в V1. V2 предоставляет более чистый и унифицированный API.

В первую очередь необходимо настроить RTOS. Сделать это можно во вкладке config parameters. По сути этот раздел изменяет файл FreeRTOSConfig.h. Описание каждого параметра приведено в ниже
### MPU/FPU

#### ENABLE_MPU

`ENABLE_MPU` - защита памяти, используется когда необходима безопасность или изоляция задач. Недоступно в CMSIS_V2.

#### ENABLE_FPU

`ENABLE_FPU` - позволяет безопасно использовать float числа. Если выключено - экономит время, но небезопасно работать с float числами.

### Config parameters

#### USE_PREEMTION

`USE_PREEMTION` - Параметр который определяет тип многозадачности.

При значении `1 (enabled)` - включает режим вытесняющей многозадачности, приостанавливает выполнение низкоприоритетной задачи (сохраняет ее сотояние и стек) при появлении готовой к выполнению высокоприоритетной и переключается на нее. При значении `0 (disabled)` включает кооперативный режим. 

При использовании кооперативного режима задачи сами должны вызывать `vTaskYIELD` в вытесняющем режиме задачи переключаются между друг другом при помощи планировщика, в кооперативном режиме нужно управлять временм вручную, кооперативный режим может привести к блокировке CPU одной задачей, в вытесняющем режиме нужно работать над синхронизацией задач.

#### USE_TIME_SLICING

`USE_TIME_SLICING` - параметр который включает равномерное выполнение задач одного приорита. Если значение параметра `1 (enabled)` то разделение времени включено. Если `0 (disabled)` то выключен.

При включенном параметре если есть несколько задач с одинаковым приоритетом готовых к выполнению, то эти задачи будут выполняться по очереди равномерно (тоесть если есть задача А и задача Б с одинаковым приоритетом то при тике 1 - выполняется задача А, на втором тике выполнение задачи А приостанавливается и начинается выполнение задачи Б, на третьем тике выполнение задачи Б приостанавливается  и продолжается выполнение задачи А и тд).

__В CMSIS_V2 нет отдельной настройки TIME_SLICING он включается автоматически при включении PREEMTION.__

#### CPU_CLOCK_HZ

`CPU_CLOCK_HZ` - частота системного тактирования ядра с которым работает FreeRTOS. По умолчанию равна частоте ядра STM. Чем выше частота тем быстрее реагирует система, но больше нагрузка на CPU и выше энергопотребление. Для обычных систем рекомендуется 1000 Гц, для энергоемких 250 - 400 Гц.

#### TICK_RATE_HZ

`TICK_RATE_HZ` - частота системного тика. От него зависят функции `osDelay()` и `vTaskDelay` (считают время в тиках). Скорость переключения задач по тайм-шерингу и точность таймеров RTOS. В реальности от 10 до 10000 Гц можно использовать.

#### MAX_PRIORITIES

`MAX_PRIORITIES` - максимальное количество приоритетов. В CMSIS_V2 по умолчанию 56. Это значит доступны приоритеты от 0 до 55, где 0 - минимальный приоритет (обрабатываются самыми последними), 55 - максимальный приоритет. Доп нагрузки не создает, только немного съедает памяти (на таблицу приоритетов)

#### MINIMAL_STACK_SIZE

`MINIMAL_STACK_SIZE` - минимальный размер стека в словах (1 слово - 4 байт).

Это значение используется для задач в которых не задан размер стека явно, а также для Idle Task и Timer Service Task если они подключены. 

В стеке задачи хранятся:

- локальные переменные
- адрес возврата при вызове функций
- Регистры CPU при переключении контекста (для CortexM около 16-20 слов)
- буфер для вызова функций `printf`, `sprintf` и др
- Значения используемые при вызовах HAL и CMSIS функций

По сути своей это рабочая память задачи.

Можно исмерить используемый стек. `UBaseType_t freeStack = uxTaskGetStackHighWaterMark(NULL);` функция вернет минимальное свободное место.

Также можно вызвать `vTaskList(char *buffer);` чтобы вывести список задач и свободный стек каждой (если включен `configUSE_TRACE_FACILITY`)

#### MAX_TASK_NAME_LEN

`MAX_TASK_NAME_LEN` - максимальная длина названия задачи в символах (включая `\0`)

#### USE_16_BIT_TICKS

`USE_16_BIT_TICKS` - использование 16-битной переменной для хранения количества тиков. В STM32 по умолчанию 0 (disable) так как 32-битная архитектура.

#### IDLE_SHOULD_YIELD

`IDLE_SHOULD_YIELD` - если `1 (enable)` то IDLE задача будет уступать другим задачам с таким же приоритетом, если `0 (disable)` то IDLE задача выполняется пока сама не отдаст управление.

#### USE_MUTEXES

`USE_MUTEXES` - включает использование мьютексов если `1 (enable)`

#### USE_RECURSIVE_MUTEXES

`USE_RECURSIVE_MUTEXES` - если `1 (enable)` то позволяет задаче взять один мьютекс несколько раз подряд если . Если задача А и Б обе блокируют один и тот же мьютекс, и А вызывает Б то без включенного параметра произойдет deadlock.

#### USE_COUNTING_SEMAPHORES 

`USE_COUNTING_SEMAPHORES` - если `1 (enable)` то включает поддержку счетных семафоров. Рекомендуется включать всегда тк нагрузка минимальна.

#### QUEUE_REGISTRY_SIZE

`QUEUE_REGISTRY_SIZE` - определяет максимальное количество очередей/семафоров которые можно зарегестрировать в реестре очередей (оставить 8 по умолчанию)

#### USE_APPLICATION_TASK_TAG 

`USE_APPLICATION_TASK_TAG` - если `1 (enable)` то позволяет каждой задаче иметь пользовательский тег (void*), который можно использовать для отладки, статистики или трейсинга.

#### ENABLE_BACKWARD_COMPATIBILITY

`ENABLE_BACKWARD_COMPATIBILITY` - если `1 (enable)` то включает возможность использовать имена функций и макросов из чистого FreeRTOS

#### USE_PORT_OPTIMISED_TASK_SELECTION

`USE_PORT_OPTIMISED_TASK_SELECTION` - если `1 (enable)` то включает оптимизированный поиск следующей задачи для процессоров, где есть аппаратная инструкция “count leading zeros” (например, Cortex-M4). У STM32f4 есть поддержка CLZ однако CubeIDE по умолчанию выключает этот параметр, однако его можно безопасно изменить в коде.

#### USE_TICKLESS_IDLE

`USE_TICKLESS_IDLE` - если `1 (enable)` то включает tickless режим — когда все задачи спят, FreeRTOS отключает системный тик (SysTick), переводя MCU в спящий режим. Сильно экономит энергопотребление, однако усложняет тайминг и отладку. Рекомендуется использовать только в low power проектах

Пробуждение происходит только по событию (например, прерыванию).

#### USE_TASK_NOTIFICATIONS

`USE_TASK_NOTIFICATIONS` - если `1 (enable)` то включает механизм уведомлений задач — это лёгкая альтернатива семафорам и очередям. Рекомендуется включать, почти не потребляет памяти и быстрее очередей.

#### RECORD_STACK_HIGH_ADDRESS

`RECORD_STACK_HIGH_ADDRESS` - если `1 (enable)` то сохраняет верхний адрес стека каждой задачи для отладочных целей (чтобы точно знать, где начинается стек).

### Memory Management Settings

#### Memory Allocation

`Memory Allocation` - выбор способа выделения памяти. 

По умолчанию в CubeIDE стоит режим dynamic/static

Dynamic allocation — задачи, очереди, семафоры и т. д. создаются через обычные функции

```
xTaskCreate()
xQueueCreate()
xSemaphoreCreateBinary()
```

Static allocation - тоже самое, но память необходимо выделять вручную

```
StaticTask_t xTaskBuffer;
StackType_t xStack[256];
xTaskCreateStatic(TaskCode, "Task", 256, NULL, 1, xStack, &xTaskBuffer);
```

В режиме Dynamic/static можно использовать оба подхода.

#### TOTAL_HEAP_SIZE

`TOTAL_HEAP_SIZE` - выбор размера кучи (heap) из которой FreeRTOS выделяет память на:

- стеки задач
- очередей, семафоров, мьютексов, таймеров
- внутренних структур ядра

Размер для STM32f4 от 512 Байт до 128 кБайт

#### Memory Management Scheme

У FreeRTOS своя схема управления кучей, которая реализуется одним из пяти файлов:

```
heap_1.c, heap_2.c, heap_3.c, heap_4.c, heap_5.c
```

Параметр `Memory Management Scheme` определяет тип управления памятью:

-`heap_1.c` - Самая простая: только выделение (malloc), без освобождения (free). Память освобождается только при перезапуске системы.

-`heap_2.c` - Поддерживает malloc и free, но память фрагментируется со временем.

-`heap_3.c` - Использует стандартные malloc() и free() из stdlib.h.

-`heap_4.c` - Поддерживает malloc() и free(), и умеет объединять соседние свободные блоки (defragmentation).

-`heap_5.c` - То же, что heap_4, но можно использовать несколько не смежных областей памяти (например, SRAM + CCMRAM).

Самый оптимальный выбор для STM32f4 для обычных проектов - `heap_4.c`.


###

| Параметр | Принимаемые значение | описание |
| ------------- | ------------- | ------------- |
| | Kernel settings | |
| `USE_PREEMTION`  | Вытесняющая многозадачность или корпоративная многозадачность | `1 (enabled)` - вытесняющая многозадачность `0 (disabled)` - кооперативная многозадачность|
| `USE_TIME_SLICING`  | Разделение задач одинакового приоритета по времени | `1 (enabled)` - включено `0 (disabled)` - выключено |
| `CPU_CLOCK_HZ`  | Частота системного тика  | Число в герцах |
| `MAX_PRIORITIES`  | Число приоритетов  | по умолчанию 56 (от 0 до 55) |
| `MINIMAL_STACK_SIZE`  | минимальный размер стека в словах (4 байта слово)  | от 64 до 3840 |
| `MAX_TASK_NAME_LEN`  | Максимальная длина названия задачи | 12 - 255 |
| `USE_16_BIT_TICKS`  | Использование 16-бит переменной для хранения количества тиков  | `1 (enable)` - использовать 16 бит `0 (disable)` - использовать 32 бит |
| `IDLE_SHOULD_YIELD`  | Должна ли уступать IDLE задача другим задачам с таким же приоритетом  | `1 (enable)` - должна `0 (disable)` - не должна |
| `USE_MUTEXES`  | Разрешает использование мьютексов  | `1 (enabled)` - включено `0 (disabled)` - выключено |
| `USE_RECURSIVE_MUTEXES`  | Разрешает использование рекурсивных мьютексов  | `1 (enabled)` - включено `0 (disabled)` - выключено |
| `USE_COUNTING_SEMAPHORES `  | Разрешает использование счетных семафоров  | `1 (enabled)` - включено `0 (disabled)` - выключено |
| `QUEUE_REGISTRY_SIZE`  | Максимальное кол-во очередей/семафоров в реестре очередей  | 0 - 255 |
| `USE_APPLICATION_TASK_TAG `  | Позволяет каждой задаче иметь пользовательский тэг  | `1 (enabled)` - включено `0 (disabled)` - выключено |
| `USE_PORT_OPTIMISED_TASK_SELECTION`  | Включает оптимизированный поиск следущей задачи (для процессоров с поддержкой CLZ)  | `1 (enabled)` - включено `0 (disabled)` - выключено |
| `USE_TICKLESS_IDLE`  | Отключение SysTick когда все задачи спят  | `1 (enabled)` - включено `0 (disabled)` - выключено |
| `USE_TASK_NOTIFICATIONS`  | Включает возможность использования TaskNotify | `1 (enabled)` - включено `0 (disabled)` - выключено |
| `RECORD_STACK_HIGH_ADDRESS`  | Включает возможность сохранять верхний адрес стека каждой задачи  | `1 (enabled)` - включено `0 (disabled)` - выключено |
| | Memory management system | |
| `Memory Allocation`  | Выбор способа выделения памяти  | dynamic, static, dynamic/static|
| `TOTAL_HEAP_SIZE`  | Размер кучи для FreeRTOS | от 512 байт до 128 кБайт |
| `Memory Management Scheme`  | Выбор режима для работы с кучей | heap_1.c - heap_5.c |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
| ``  | Content Cell  | Content Cell |
